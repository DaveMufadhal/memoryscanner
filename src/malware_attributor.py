"""
Malware Family Attribution Module
Identifies specific malware families from YARA matches and behavioral patterns
"""

import re
from typing import Dict, List, Set, Optional, Tuple


class MalwareAttributor:
    """
    Identifies malware families from:
    - YARA rule matches
    - Behavioral pattern correlation
    - Network IOCs
    - File/process artifacts
    """
    
    def __init__(self):
        # Known malware family patterns in YARA rule names
        self.malware_patterns = {
            # RATs (Remote Access Trojans)
            r'AsyncRAT|async[-_]?rat': {'family': 'AsyncRAT', 'type': 'RAT', 'severity': 'CRITICAL'},
            r'Quasar[-_]?RAT|quasar': {'family': 'QuasarRAT', 'type': 'RAT', 'severity': 'CRITICAL'},
            r'NanoCore|nanocore': {'family': 'NanoCore RAT', 'type': 'RAT', 'severity': 'CRITICAL'},
            r'DarkComet|darkcomet': {'family': 'DarkComet', 'type': 'RAT', 'severity': 'CRITICAL'},
            r'Gh0st[-_]?RAT|gh0st': {'family': 'Gh0st RAT', 'type': 'RAT', 'severity': 'CRITICAL'},
            r'PoisonIvy|poison[-_]ivy': {'family': 'Poison Ivy', 'type': 'RAT', 'severity': 'CRITICAL'},
            r'NjRAT|njrat': {'family': 'njRAT', 'type': 'RAT', 'severity': 'CRITICAL'},
            r'Remcos|remcos': {'family': 'Remcos', 'type': 'RAT', 'severity': 'CRITICAL'},
            r'Agent[-_]?Tesla|agenttesla': {'family': 'Agent Tesla', 'type': 'Keylogger/RAT', 'severity': 'CRITICAL'},
            
            # Ransomware
            r'WannaCry|wannacry|wcry': {'family': 'WannaCry', 'type': 'Ransomware', 'severity': 'CRITICAL'},
            r'Ryuk|ryuk': {'family': 'Ryuk', 'type': 'Ransomware', 'severity': 'CRITICAL'},
            r'Maze|maze[-_]ransomware': {'family': 'Maze', 'type': 'Ransomware', 'severity': 'CRITICAL'},
            r'Conti|conti': {'family': 'Conti', 'type': 'Ransomware', 'severity': 'CRITICAL'},
            r'LockBit|lockbit': {'family': 'LockBit', 'type': 'Ransomware', 'severity': 'CRITICAL'},
            r'REvil|revil|sodinokibi': {'family': 'REvil', 'type': 'Ransomware', 'severity': 'CRITICAL'},
            
            # Trojans/Loaders
            r'Emotet|emotet': {'family': 'Emotet', 'type': 'Trojan/Loader', 'severity': 'HIGH'},
            r'TrickBot|trickbot': {'family': 'TrickBot', 'type': 'Trojan/Loader', 'severity': 'HIGH'},
            r'Qbot|qakbot|qbot': {'family': 'Qbot', 'type': 'Trojan/Loader', 'severity': 'HIGH'},
            r'IcedID|icedid': {'family': 'IcedID', 'type': 'Trojan/Loader', 'severity': 'HIGH'},
            r'Cobalt[-_]?Strike|cobaltstrike': {'family': 'Cobalt Strike', 'type': 'Post-Exploitation', 'severity': 'HIGH'},
            
            # Info stealers
            r'Mimikatz|mimikatz': {'family': 'Mimikatz', 'type': 'Credential Stealer', 'severity': 'HIGH'},
            r'RedLine|redline': {'family': 'RedLine Stealer', 'type': 'Info Stealer', 'severity': 'HIGH'},
            r'Raccoon[-_]?Stealer|raccoon': {'family': 'Raccoon Stealer', 'type': 'Info Stealer', 'severity': 'HIGH'},
            r'Azorult|azorult': {'family': 'Azorult', 'type': 'Info Stealer', 'severity': 'HIGH'},
            r'Vidar|vidar': {'family': 'Vidar', 'type': 'Info Stealer', 'severity': 'HIGH'},
            
            # Miners
            r'XMRig|xmrig': {'family': 'XMRig', 'type': 'Cryptominer', 'severity': 'MEDIUM'},
            r'CoinMiner|coinminer': {'family': 'CoinMiner', 'type': 'Cryptominer', 'severity': 'MEDIUM'},
            
            # Backdoors
            r'Meterpreter|meterpreter': {'family': 'Meterpreter', 'type': 'Backdoor', 'severity': 'HIGH'},
            r'China[-_]?Chopper|chinachopper': {'family': 'China Chopper', 'type': 'Web Shell', 'severity': 'HIGH'},
        }
        
        # Compile patterns for performance
        self.compiled_patterns = {
            re.compile(pattern, re.IGNORECASE): info 
            for pattern, info in self.malware_patterns.items()
        }
    
    def identify_from_yara(self, yara_findings: List[Dict]) -> Dict[str, Dict]:
        """
        Extract malware family from YARA rule matches.
        
        Returns:
            Dict mapping malware families to their details
        """
        identified_families = {}
        
        for finding in yara_findings:
            rule_name = finding.get('rule_name') or finding.get('rule', '')
            
            # Try to match against known malware patterns
            for pattern, info in self.compiled_patterns.items():
                if pattern.search(rule_name):
                    family = info['family']
                    
                    if family not in identified_families:
                        identified_families[family] = {
                            'family': family,
                            'type': info['type'],
                            'severity': info['severity'],
                            'yara_rules': [],
                            'confidence': 'HIGH',  # YARA match = high confidence
                            'indicators': []
                        }
                    
                    identified_families[family]['yara_rules'].append(rule_name)
                    identified_families[family]['indicators'].append(f"YARA: {rule_name}")
                    break
        
        return identified_families
    
    def identify_from_behavior(self, analysis_result) -> Dict[str, Dict]:
        """
        Identify malware families from behavioral patterns.
        
        Args:
            analysis_result: AnalysisResult object with detection findings
        
        Returns:
            Dict mapping malware families to their details
        """
        behavioral_families = {}
        
        # RAT behavioral indicators
        rat_indicators = []
        if analysis_result.lateral_movement_detections:
            rat_indicators.append("Lateral movement detected")
        if analysis_result.credential_theft:
            rat_indicators.append("Credential theft attempts")
        if analysis_result.data_exfiltration:
            rat_indicators.append("Data exfiltration")
        if analysis_result.process_hollowing or analysis_result.hollowed_processes:
            rat_indicators.append("Process hollowing/injection")
        
        if len(rat_indicators) >= 2:
            behavioral_families['Generic RAT'] = {
                'family': 'Generic RAT',
                'type': 'RAT',
                'severity': 'HIGH',
                'confidence': 'MEDIUM',  # Behavioral only = medium confidence
                'indicators': rat_indicators
            }
        
        # Ransomware behavioral indicators
        ransom_indicators = []
        if analysis_result.ransomware_indicators:
            ransom_indicators.extend([f"Ransomware: {ind.get('reason', 'Unknown')}" 
                                     for ind in analysis_result.ransomware_indicators])
        
        if ransom_indicators:
            behavioral_families['Generic Ransomware'] = {
                'family': 'Generic Ransomware',
                'type': 'Ransomware',
                'severity': 'CRITICAL',
                'confidence': 'MEDIUM',
                'indicators': ransom_indicators
            }
        
        # Rootkit behavioral indicators
        rootkit_indicators = []
        if analysis_result.rootkit_indicators:
            rootkit_indicators.extend([f"Rootkit: {ind.get('reason', 'Unknown')}" 
                                      for ind in analysis_result.rootkit_indicators])
        if analysis_result.api_hooks:
            rootkit_indicators.append(f"API hooks: {len(analysis_result.api_hooks)}")
        
        if rootkit_indicators:
            behavioral_families['Generic Rootkit'] = {
                'family': 'Generic Rootkit',
                'type': 'Rootkit',
                'severity': 'CRITICAL',
                'confidence': 'MEDIUM',
                'indicators': rootkit_indicators
            }
        
        return behavioral_families
    
    def generate_attribution_summary(self, analysis_result) -> str:
        """
        Generate human-readable malware attribution summary.
        
        Args:
            analysis_result: AnalysisResult object with YARA findings
        
        Returns:
            Formatted summary string
        """
        # Get attributions from both sources
        yara_families = self.identify_from_yara(analysis_result.yara_findings)
        behavioral_families = self.identify_from_behavior(analysis_result)
        
        # Merge (YARA takes precedence)
        all_families = {**behavioral_families, **yara_families}
        
        if not all_families:
            return "No specific malware families identified."
        
        # Store attribution in analysis result for report template
        analysis_result.malware_families = all_families
        
        summary_lines = []
        summary_lines.append(f"**Identified Malware Families:** {len(all_families)}")
        summary_lines.append("")
        
        for family_name, details in sorted(all_families.items(), 
                                           key=lambda x: (x[1]['severity'], x[0])):
            severity_emoji = {
                'CRITICAL': 'ðŸ”´',
                'HIGH': 'ðŸŸ ',
                'MEDIUM': 'ðŸŸ¡',
                'LOW': 'ðŸŸ¢'
            }.get(details['severity'], 'âšª')
            
            summary_lines.append(f"### {severity_emoji} {details['family']}")
            summary_lines.append(f"**Type:** {details['type']}")
            summary_lines.append(f"**Severity:** {details['severity']}")
            summary_lines.append(f"**Confidence:** {details['confidence']}")
            
            if details.get('yara_rules'):
                summary_lines.append(f"**YARA Rules Matched:** {', '.join(details['yara_rules'][:3])}")
            
            summary_lines.append("**Indicators:**")
            for indicator in details['indicators'][:5]:
                summary_lines.append(f"- {indicator}")
            
            summary_lines.append("")
        
        return "\n".join(summary_lines)
    
    def enrich_yara_findings(self, yara_findings: List[Dict]) -> List[Dict]:
        """
        Enrich YARA findings with malware family information.
        
        Args:
            yara_findings: List of YARA match dictionaries
        
        Returns:
            Enriched findings with malware_family field added
        """
        enriched = []
        
        for finding in yara_findings:
            enriched_finding = finding.copy()
            rule_name = finding.get('rule_name') or finding.get('rule', '')
            
            # Try to match against known malware patterns
            for pattern, info in self.compiled_patterns.items():
                if pattern.search(rule_name):
                    enriched_finding['malware_family'] = info['family']
                    enriched_finding['malware_type'] = info['type']
                    enriched_finding['severity'] = info.get('severity', enriched_finding.get('severity', 'MEDIUM'))
                    break
            
            enriched.append(enriched_finding)
        
        return enriched


def add_malware_attribution(analysis_result) -> str:
    """
    Main function to add malware family attribution to analysis results.
    
    Args:
        analysis_result: AnalysisResult object
    
    Returns:
        Attribution summary text
    """
    attributor = MalwareAttributor()
    
    # Enrich YARA findings with malware family info
    if analysis_result.yara_findings:
        analysis_result.yara_findings = attributor.enrich_yara_findings(
            analysis_result.yara_findings
        )
    
    # Generate and return summary
    return attributor.generate_attribution_summary(analysis_result)
